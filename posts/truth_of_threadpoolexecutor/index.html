<!DOCTYPE html><html lang="ko-KR" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8829030678254956" crossorigin="anonymous"></script><meta name="pv-proxy-endpoint" content=""><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="ThreadPoolExecutor에 대한 오해와 진실" /><meta name="author" content="leeyh0216" /><meta property="og:locale" content="ko_KR" /><meta name="description" content="ThreadPoolExecutor에 대한 오해와 진실" /><meta property="og:description" content="ThreadPoolExecutor에 대한 오해와 진실" /><link rel="canonical" href="https://leeyh0216.github.io/posts/truth_of_threadpoolexecutor/" /><meta property="og:url" content="https://leeyh0216.github.io/posts/truth_of_threadpoolexecutor/" /><meta property="og:site_name" content="leeyh0216’s devlog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-02-21T01:00:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="ThreadPoolExecutor에 대한 오해와 진실" /><meta name="twitter:site" content="@twitter_username" /><meta name="twitter:creator" content="@leeyh0216" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"leeyh0216"},"description":"ThreadPoolExecutor에 대한 오해와 진실","url":"https://leeyh0216.github.io/posts/truth_of_threadpoolexecutor/","@type":"BlogPosting","headline":"ThreadPoolExecutor에 대한 오해와 진실","dateModified":"2020-02-21T01:00:00+09:00","datePublished":"2020-02-21T01:00:00+09:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://leeyh0216.github.io/posts/truth_of_threadpoolexecutor/"},"@context":"https://schema.org"}</script><title>ThreadPoolExecutor에 대한 오해와 진실 | leeyh0216's devlog</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="https://cdn.jsdelivr.net/npm/countup.js@1.9.3/dist/countUp.min.js"></script> <script async src="/assets/js/dist/pvreport.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-129061352-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-129061352-1'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://cdn.jsdelivr.net/gh/cotes2020/chirpy-images/commons/avatar.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">leeyh0216's devlog</a></div><div class="site-subtitle font-italic">개발/일상 블로그</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/leeyh0216" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://www.linkedin.com/in/%EC%9A%A9%ED%99%98-%EC%9D%B4-84222a119/" aria-label="linkedin" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['leeyh0216','gmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>ThreadPoolExecutor에 대한 오해와 진실</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>ThreadPoolExecutor에 대한 오해와 진실</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> leeyh0216 </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Fri, Feb 21, 2020, 1:00 AM +0900" prep="on" > Feb 21, 2020 <i class="unloaded">2020-02-21T01:00:00+09:00</i> </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2041 words">11 min</span> <span id="pv" class="pageviews"><i class="fas fa-spinner fa-spin fa-fw"></i></span></div></div><div class="post-content"><h1 id="threadpoolexecutor에-대한-오해와-진실">ThreadPoolExecutor에 대한 오해와 진실</h1><p>회사에서 팀원 분이 코드 리뷰를 해주셨는데, <code class="language-plaintext highlighter-rouge">ThreadPoolExecutor</code>을 잘못 사용하고 있다는 내용이었다.</p><p>내가 작성한 원본 코드는 대략 아래와 같다.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre>int numTasks = 60;
CountDownLatch countDownLatch = new CountDownLatch(numTasks);
ThreadPoolExecutor threadPoolExecutor= new ThreadPoolExecutor(10, 50, 10, TimeUnit.SECONDS, new LinkedBlockingQueue&lt;&gt;());

for(int i = 0; i &lt; numTasks; i++){
    threadPoolExecutor.submit(() -&gt; {
        //Do something
        countDownLatch.countDown();
    });
}
</pre></table></code></div></div><p>단순히 <code class="language-plaintext highlighter-rouge">ThreadPoolExecutor</code>의 초기화 인자만 보고 난 다음과 같이 추측했다.(Do something은 충분히 처리 시간이 긴 작업이 수행된다고 가정)</p><ol><li><code class="language-plaintext highlighter-rouge">ThreadPoolExecutor</code> 초기화 직후에는 <code class="language-plaintext highlighter-rouge">Thread</code>가 존재하지 않는다.<li>Loop에서 10개의 작업이 submit 된 이후까지는 순차적으로 <code class="language-plaintext highlighter-rouge">Thread</code>가 생성되어 총 10개의 <code class="language-plaintext highlighter-rouge">Thread</code>가 존재한다.<li>11번째 ~ 50번째의 작업은 <code class="language-plaintext highlighter-rouge">corePoolSize</code>를 넘어섰으나, <code class="language-plaintext highlighter-rouge">maxPoolSize</code>에 도달하지 않았기 때문에, 동적으로 <code class="language-plaintext highlighter-rouge">Thread</code>의 수가 증가한다. 즉, 50개의 <code class="language-plaintext highlighter-rouge">Thread</code>가 존재한다.<li>51번째 ~ 60번째의 작업은 <code class="language-plaintext highlighter-rouge">ThreadPoolExecutor</code>의 Thread 수가 <code class="language-plaintext highlighter-rouge">maxPoolSize</code>를 넘어섰기 때문에 <code class="language-plaintext highlighter-rouge">Queue</code>에서 대기한다.</ol><p>위의 추측은 <strong>완전히 틀렸다</strong>.</p><h2 id="실제로는-어떻게-동작하는가">실제로는 어떻게 동작하는가?</h2><p>동시에 실행되는 최대 작업의 갯수(Active Count)와 <code class="language-plaintext highlighter-rouge">Queue</code>에서 대기하는 <code class="language-plaintext highlighter-rouge">Runnable</code>의 갯수가 몇 개인지 확인해보기 위해 아래와 같이 500ms 마다 출력 구문을 추가하였다.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre>int numTasks = 60;
BlockingQueue&lt;Runnable&gt; blockingQueue = new LinkedBlockingQueue&lt;&gt;();
CountDownLatch countDownLatch = new CountDownLatch(numTasks);
ThreadPoolExecutor threadPoolExecutor= new ThreadPoolExecutor(10, 50, 10,
    TimeUnit.SECONDS, blockingQueue);

for(int i = 0; i &lt; numTasks; i++){
    threadPoolExecutor.submit(() -&gt; {
        try {
            Thread.sleep(1000);
        }
        catch(Exception e){
		}
        countDownLatch.countDown();
    });
}

for(int i = 0; i &lt; 120; i++){
    Thread.sleep(500);
	//현재 실행 중인 Thread의 수 출력
    System.out.println("Active: " + threadPoolExecutor.getActiveCount());
	//Queue에서 대기 중인 작업 갯수 출력
    System.out.println("Queue: " + blockingQueue.size());
}

threadPoolExecutor.shutdown();
</pre></table></code></div></div><p>위 코드를 실행한 결과는 아래와 같다.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre>Active: 10
Queue: 50
Active: 10
Queue: 40
Active: 10
Queue: 40
Active: 10
Queue: 30
Active: 10
Queue: 30
Active: 10
...
</pre></table></code></div></div><p>한 번에 동시에 실행되는 갯수는 <code class="language-plaintext highlighter-rouge">ThreadPoolExecutor</code>를 초기화 할 때 설정해주었던 <code class="language-plaintext highlighter-rouge">corePoolSize</code>인 10개이고, 그 갯수를 넘어서면 <code class="language-plaintext highlighter-rouge">maxPoolSize</code>만큼 동적으로 확장되어 실행되는 것이 아니고, <code class="language-plaintext highlighter-rouge">Queue</code>에서 대기를 하고 있었다.</p><h2 id="뭐가-잘못된-걸까">뭐가 잘못된 걸까?</h2><p>그냥 내가 <code class="language-plaintext highlighter-rouge">ThreadPoolExecutor</code>의 JavaDoc을 제대로 읽지 않은게 실수였다.</p><p>오라클에서 제공하는 <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ThreadPoolExecutor.html">ThreadPoolExecutor의 JavaDoc</a>을 읽어보면, <code class="language-plaintext highlighter-rouge">corePoolSize</code>와 <code class="language-plaintext highlighter-rouge">maxPoolSize</code>에 대해 다음과 같이 기술되어 있다.</p><blockquote><p>A ThreadPoolExecutor will automatically adjust the pool size (see getPoolSize()) according to the bounds set by corePoolSize (see getCorePoolSize()) and maximumPoolSize (see getMaximumPoolSize()). When a new task is submitted in method execute(Runnable), and fewer than corePoolSize threads are running, a new thread is created to handle the request, even if other worker threads are idle. If there are more than corePoolSize but less than maximumPoolSize threads running, a new thread will be created only if the queue is full. By setting corePoolSize and maximumPoolSize the same, you create a fixed-size thread pool. By setting maximumPoolSize to an essentially unbounded value such as Integer.MAX_VALUE, you allow the pool to accommodate an arbitrary number of concurrent tasks. Most typically, core and maximum pool sizes are set only upon construction, but they may also be changed dynamically using setCorePoolSize(int) and setMaximumPoolSize(int).</p></blockquote><p>정리해보자면 <code class="language-plaintext highlighter-rouge">execute</code> 혹은 <code class="language-plaintext highlighter-rouge">submit</code>을 통해 새로운 <code class="language-plaintext highlighter-rouge">Runnable</code> 실행을 <code class="language-plaintext highlighter-rouge">ThreadPoolExecutor</code>에게 요청했을 때, 아래와 같이 처리된다.</p><ol><li><code class="language-plaintext highlighter-rouge">corePoolSize</code>보다 적은 <code class="language-plaintext highlighter-rouge">Thread</code>가 수행되고 있었던 경우: 실행 요청한 <code class="language-plaintext highlighter-rouge">Runnable</code>을 수행하기 위한 <code class="language-plaintext highlighter-rouge">Thread</code>를 새로 생성하여 즉시 실행한다.<li><code class="language-plaintext highlighter-rouge">corePoolSize</code>보다 많은 <code class="language-plaintext highlighter-rouge">Thread</code>가 수행되고 있지만, <code class="language-plaintext highlighter-rouge">maxPoolSize</code>보다 적은 수의 <code class="language-plaintext highlighter-rouge">Thread</code>가 수행되고 있는 경우:<ol><li><code class="language-plaintext highlighter-rouge">Queue</code>가 가득 차지 않은 경우: 즉시 실행하지 않고 <code class="language-plaintext highlighter-rouge">Queue</code>에 <code class="language-plaintext highlighter-rouge">Runnable</code>을 넣는다.<li><code class="language-plaintext highlighter-rouge">Queue</code>가 가득 찬 경우: <code class="language-plaintext highlighter-rouge">maxPoolSize</code>까지 <code class="language-plaintext highlighter-rouge">Thread</code>를 더 만들어 실행한다.</ol></ol><p>즉, <code class="language-plaintext highlighter-rouge">maxPoolSize</code>만큼 확장되는 것보다 <code class="language-plaintext highlighter-rouge">Queue</code>를 채우는 작업이 우선한다. <code class="language-plaintext highlighter-rouge">Queue</code>의 크기를 넘어선 수의 작업들이 요청되었을 때만 <code class="language-plaintext highlighter-rouge">maxPoolSize</code>만큼 확장된다.</p><h2 id="maxpoolsize가-동작하게-하는-방법"><code class="language-plaintext highlighter-rouge">maxPoolSize</code>가 동작하게 하는 방법</h2><p><code class="language-plaintext highlighter-rouge">maxPoolSize</code> 옵션이 동작하게 하려면 <code class="language-plaintext highlighter-rouge">Queue</code> 초기화 시 <code class="language-plaintext highlighter-rouge">Capacity</code>를 고정시키면 된다.</p><p>위에서 <code class="language-plaintext highlighter-rouge">Queue</code>를 초기화 할 때는 <code class="language-plaintext highlighter-rouge">Capacity</code>를 지정하지 않은 <code class="language-plaintext highlighter-rouge">LinkedBlockingQueue</code>를 할당하였다.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>BlockingQueue&lt;Runnable&gt; blockingQueue = new LinkedBlockingQueue&lt;&gt;();
</pre></table></code></div></div><p>위 기본 생성자의 경우 <code class="language-plaintext highlighter-rouge">Queue</code>의 <code class="language-plaintext highlighter-rouge">Capacity</code>를 <code class="language-plaintext highlighter-rouge">Integer.MAX_VALUE</code>로 설정해버린다.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>public LinkedBlockingQueue() {
    this(2147483647);
}
</pre></table></code></div></div><p>그렇기 때문에 아래와 같이 고정된 <code class="language-plaintext highlighter-rouge">Capacity</code>로 설정해야 한다. 나는 10 크기를 가지는 <code class="language-plaintext highlighter-rouge">Queue</code>로 초기화했다.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>BlockingQueue&lt;Runnable&gt; blockingQueue = new LinkedBlockingQueue&lt;&gt;(10);
</pre></table></code></div></div><p>이후 다시 코드를 수행하면 아래와 같은 출력이 발생한다.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>Active: 50
Queue: 10
Active: 10
Queue: 0
Active: 10
Queue: 0
...
</pre></table></code></div></div><p>전체 제출 작업의 수가 60개, <code class="language-plaintext highlighter-rouge">corePoolSize</code>가 10개, <code class="language-plaintext highlighter-rouge">maxPoolSize</code>가 50개, <code class="language-plaintext highlighter-rouge">Queue</code>의 <code class="language-plaintext highlighter-rouge">Capacity</code>가 10이기 때문에, 아래와 같이 동작할 것이다.</p><ol><li>최초 제출된 10개의 작업은 바로 <code class="language-plaintext highlighter-rouge">Thread</code>가 생성되어 실행된다.(Active: 10)<li>그 다음 제출된 10개의 작업은 <code class="language-plaintext highlighter-rouge">Queue</code>에 쌓인다.(Active: 10)<li>그 다음 제출된 40개의 작업은 <code class="language-plaintext highlighter-rouge">Queue</code>가 가득 찼기 때문에 아래와 같이 수행된다.<ol><li><code class="language-plaintext highlighter-rouge">Queue</code>에 있던 10개의 작업 실행(Active: 20)<li>또 10개의 작업이 <code class="language-plaintext highlighter-rouge">Queue</code>에 삽입(Active: 20)<li><code class="language-plaintext highlighter-rouge">Queue</code>에 있던 10개의 작업 실행(Active: 30)<li>또 10개의 작업이 <code class="language-plaintext highlighter-rouge">Queue</code>에 삽입(Active: 30)<li><code class="language-plaintext highlighter-rouge">Queue</code>에 있던 10개의 작업 실행(Active: 40)<li>또 10개의 작업이 <code class="language-plaintext highlighter-rouge">Queue</code>에 삽입(Active: 40)<li><code class="language-plaintext highlighter-rouge">Queue</code>에 있던 10개의 작업 실행(Active: 50)<li>또 10개의 작업이 <code class="language-plaintext highlighter-rouge">Queue</code>에 삽입(Active: 50)<li>Active Thread가 <code class="language-plaintext highlighter-rouge">maxPoolSize</code>와 같아졌기 때문에 나머지 10개의 <code class="language-plaintext highlighter-rouge">Runnable</code>은 Queue에서 대기</ol><li>최초 10개의 작업이 완료되며 <code class="language-plaintext highlighter-rouge">Queue</code>에 있던 작업 10개가 실행됨(Active: 50). <code class="language-plaintext highlighter-rouge">Queue</code>는 비게 됨</ol><h2 id="그래서-나는-어떻게-했는가">그래서 나는 어떻게 했는가?</h2><p><code class="language-plaintext highlighter-rouge">ThreadPoolExecutor</code>를 사용한 이유는 가용 자원이 한정적이기 때문이었다. 다만, 사용자가 작업 실행 요청을 하면 자원이 없더라도 일단 대기 <code class="language-plaintext highlighter-rouge">Queue</code>에 넣어 놓고 가용 자원이 확보될 때까지 기다려야 했다.</p><p>문제는 사용자의 작업 요청이 몇 건이 들어올 지 모른다는 것이다. 최소 한건 ~ 최대 수십, 수백 건까지 들어올 수 있었다.</p><p>만일 위의 예제에서의 60건의 작업이 아닌 100건의 작업이 들어온다고 가정해보자.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre>//기존 60건에서 100건으로 증가. 다른 옵션들은 조정하지 않음
int numTasks = 100;
BlockingQueue&lt;Runnable&gt; blockingQueue = new LinkedBlockingQueue&lt;&gt;(10);
CountDownLatch countDownLatch = new CountDownLatch(numTasks);
ThreadPoolExecutor threadPoolExecutor= new ThreadPoolExecutor(10, 50, 10,
    TimeUnit.SECONDS, blockingQueue);

for(int i = 0; i &lt; numTasks; i++){
    threadPoolExecutor.submit(() -&gt; {
        try {
            Thread.sleep(1000);
        }
        catch(Exception e){
		}
        countDownLatch.countDown();
    });
}
</pre></table></code></div></div><p>위 코드를 실행하면 다음과 같은 오류가 발생한다.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>Exception in thread "main" java.util.concurrent.RejectedExecutionException: Task java.util.concurrent.FutureTask@574caa3f[Not completed, task = java.util.concurrent.Executors$RunnableAdapter@59690aa4[Wrapped task = com.leeyh0216.jpa.ThreadPoolTest$$Lambda$1/0x0000000800060840@6842775d]] rejected from java.util.concurrent.ThreadPoolExecutor@64cee07[Running, pool size = 50, active threads = 50, queued tasks = 10, completed tasks = 0]
</pre></table></code></div></div><p>Active Thread가 50개, Queue의 갯수가 10개이기 때문에 나머지 40개의 작업은 Queue에 저장할 수 없고, 이에 <code class="language-plaintext highlighter-rouge">submit</code> 실행 시 <code class="language-plaintext highlighter-rouge">RejectedExecutionException</code>이 발생하는 것이다.</p><p>위의 요구사항은 “한정된 가용자원”을 위해 동시 실행 작업의 갯수를 제한시키고 “사용자의 요청”은 대기하다가 나중에는 꼭 실행시켜야했기 때문에, <code class="language-plaintext highlighter-rouge">Queue</code>의 크기를 넘는 요청을 받아들일 수 있어야 했다. 즉, 사용자 요청 시 <code class="language-plaintext highlighter-rouge">RejectedExecutionException</code>이 발생해서는 안되었다.</p><p>이에 기존과 같이 <code class="language-plaintext highlighter-rouge">Integer.MAX_VALUE</code>만큼의 <code class="language-plaintext highlighter-rouge">Queue</code> 크기를 사용하도록 설정하여 문제를 해결하였다(?? 처음이랑 똑같군… 허탈…).</p><p>자세한 상황은 Oracle 문서를 참고하자!!</p></div><div class="post-tail-wrapper text-muted"><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/java/" class="post-tag no-text-decoration" >java</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=ThreadPoolExecutor에 대한 오해와 진실 - leeyh0216's devlog&url=https://leeyh0216.github.io/posts/truth_of_threadpoolexecutor/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=ThreadPoolExecutor에 대한 오해와 진실 - leeyh0216's devlog&u=https://leeyh0216.github.io/posts/truth_of_threadpoolexecutor/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=ThreadPoolExecutor에 대한 오해와 진실 - leeyh0216's devlog&url=https://leeyh0216.github.io/posts/truth_of_threadpoolexecutor/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ps/">ps</a> <a class="post-tag" href="/tags/spring/">spring</a> <a class="post-tag" href="/tags/leetcode/">leetcode</a> <a class="post-tag" href="/tags/apache-spark/">apache-spark</a> <a class="post-tag" href="/tags/java/">java</a> <a class="post-tag" href="/tags/kafka/">kafka</a> <a class="post-tag" href="/tags/apache-druid/">apache-druid</a> <a class="post-tag" href="/tags/string/">string</a> <a class="post-tag" href="/tags/study/">study</a> <a class="post-tag" href="/tags/docker/">docker</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/trino-slice/"><div class="card-body"> <span class="timeago small" > Dec 24, 2022 <i class="unloaded">2022-12-24T15:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Java Object의 Memory Layout과 Trino의 Slice</h3><div class="text-muted small"><p> Java Object의 Memory Layout Data structure alignment WORD CPU에서 어떤 작업을 하기 위해서는 메모리 영역의 데이터를 레지스터로 옮겨야 한다. 이 때 CPU가 레지스터로 데이터를 옮겨오는 단위를 WORD라고 한다. WORD의 크기는 CPU마다 다르다. 32bit CPU에서는 WORD의 크기가 3...</p></div></div></a></div><div class="card"> <a href="/posts/Orc-Impl-1/"><div class="card-body"> <span class="timeago small" > Jan 1, 2023 <i class="unloaded">2023-01-01T01:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>ORC Spec을 보고 Reader/Writer를 구현해보기 - PostScript</h3><div class="text-muted small"><p> 개요 대부분의 오픈소스 ETL 프로젝트(Spark, Flink 등)들에서는 ORC, Parquet 등의 컬럼 기반 파일 포맷의 읽기/쓰기를 지원하며, 고수준 API를 통해 간단히 특정 포맷으로의 읽기/쓰기를 수행할 수 있다. 1 2 3 4 5 -- ORC의 읽기 spark.read.orc("PATH_TO_READ").show(100, false) ...</p></div></div></a></div><div class="card"> <a href="/posts/trino-summit-2023/"><div class="card-body"> <span class="timeago small" > Dec 16, 2023 <i class="unloaded">2023-12-16T18:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Trino Summit 2023 발표 회고</h3><div class="text-muted small"><p> Trino Summit 2023 2023년 12월 13 ~ 14일(한국 기준 14 ~ 15일)에 Trino Summit 2023이 온라인에서 열렸다. Trino 블로그에도 Trino Summit 2023 nears with an awesome lineup에 “SK Telecom: Unstructured data analysis using polym...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/spring-sleuth-propagate/" class="btn btn-outline-primary" prompt="Older"><p>Spring Sleuth 사용 시 Thread 간 Trace ID가 공유되지 않는 문제 해결하기</p></a> <a href="/posts/leetcode_contest_178/" class="btn btn-outline-primary" prompt="Newer"><p>LeetCode Weekly Contest 178</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://twitter.com/username">leeyh0216</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/ps/">ps</a> <a class="post-tag" href="/tags/spring/">spring</a> <a class="post-tag" href="/tags/leetcode/">leetcode</a> <a class="post-tag" href="/tags/apache-spark/">apache spark</a> <a class="post-tag" href="/tags/java/">java</a> <a class="post-tag" href="/tags/kafka/">kafka</a> <a class="post-tag" href="/tags/apache-druid/">apache druid</a> <a class="post-tag" href="/tags/string/">string</a> <a class="post-tag" href="/tags/study/">study</a> <a class="post-tag" href="/tags/docker/">docker</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://leeyh0216.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
