<!DOCTYPE html><html lang="ko-KR" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8829030678254956" crossorigin="anonymous"></script><meta name="pv-proxy-endpoint" content=""><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="Closure란?" /><meta name="author" content="leeyh0216" /><meta property="og:locale" content="ko_KR" /><meta name="description" content="Closure보다 먼저 알아야할 개념들" /><meta property="og:description" content="Closure보다 먼저 알아야할 개념들" /><link rel="canonical" href="https://leeyh0216.github.io/posts/closure/" /><meta property="og:url" content="https://leeyh0216.github.io/posts/closure/" /><meta property="og:site_name" content="leeyh0216’s devlog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-01-21T23:00:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Closure란?" /><meta name="twitter:site" content="@twitter_username" /><meta name="twitter:creator" content="@leeyh0216" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"leeyh0216"},"description":"Closure보다 먼저 알아야할 개념들","url":"https://leeyh0216.github.io/posts/closure/","@type":"BlogPosting","headline":"Closure란?","dateModified":"2021-01-21T23:00:00+09:00","datePublished":"2021-01-21T23:00:00+09:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://leeyh0216.github.io/posts/closure/"},"@context":"https://schema.org"}</script><title>Closure란? | leeyh0216's devlog</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="https://cdn.jsdelivr.net/npm/countup.js@1.9.3/dist/countUp.min.js"></script> <script async src="/assets/js/dist/pvreport.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-129061352-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-129061352-1'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://cdn.jsdelivr.net/gh/cotes2020/chirpy-images/commons/avatar.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">leeyh0216's devlog</a></div><div class="site-subtitle font-italic">개발/일상 블로그</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/leeyh0216" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://www.linkedin.com/in/%EC%9A%A9%ED%99%98-%EC%9D%B4-84222a119/" aria-label="linkedin" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['leeyh0216','gmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Closure란?</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Closure란?</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> leeyh0216 </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Thu, Jan 21, 2021, 11:00 PM +0900" prep="on" > Jan 21, 2021 <i class="unloaded">2021-01-21T23:00:00+09:00</i> </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1746 words">9 min</span> <span id="pv" class="pageviews"><i class="fas fa-spinner fa-spin fa-fw"></i></span></div></div><div class="post-content"><h1 id="closure보다-먼저-알아야할-개념들">Closure보다 먼저 알아야할 개념들</h1><h2 id="lexical-scope-vs-dynamic-scope">Lexical scope vs Dynamic scope</h2><p>Lexical scope를 사용하는 언어(C, C++, Java, Javascript 등)에서는 <strong>소스코드 내에서 변수나 함수가 정의된 위치와 Lexical Context를 기준</strong>으로 이름 참조(Name resolution)를 수행한다. 찾아야하는 이름이 내부 Lexical context에 존재하지 않는 경우 외부 Lexical context에서 이를 찾고, 모든 외부 Lexical context에도 해당 이름이 존재하지 않는 경우 오류가 발생한다.</p><figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">variable in global</span><span class="dl">"</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">inner</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">x</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">outer</span><span class="p">()</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">variable in outer</span><span class="dl">"</span><span class="p">;</span>
  <span class="nx">inner</span><span class="p">();</span>
<span class="p">}</span>

<span class="nx">inner</span><span class="p">();</span>
<span class="nx">outer</span><span class="p">();</span></code></pre></figure><p>위의 Javascript 코드를 실행하면 아래와 같은 결과가 출력된다.</p><figure class="highlight"><pre><code class="language-bash" data-lang="bash">variable <span class="k">in </span>global
variable <span class="k">in </span>global</code></pre></figure><p>Javascript는 Lexical scope를 사용하는 언어이기 떄문에 <code class="language-plaintext highlighter-rouge">inner</code>가 <code class="language-plaintext highlighter-rouge">x</code>라는 변수의 이름을 찾을 때에는 자신의 Lexical Context(<code class="language-plaintext highlighter-rouge">inner</code> 함수의 Body)에서 우선 <code class="language-plaintext highlighter-rouge">x</code>를 찾는다. 여기에 <code class="language-plaintext highlighter-rouge">x</code>가 없었기 때문에 자신의 전역 Lexical Scope에 위치한 <code class="language-plaintext highlighter-rouge">x</code>(“variable in global”)을 참조하게 된다. 이와 같이 Lexical scope를 사용하는 언어는 Compile time에 함수 혹은 변수 이름의 바인딩이 가능하기 때문에 Early Binding이라고도 불린다.</p><p>반면에 Dynamic scope를 사용하는 언어(bash, jinja 등)에서는 <strong>실행 시점의 컨텍스트를 기준</strong>으로 이름 참조를 수행한다. 찾아야하는 이름이 현재 실행 컨텍스트에 존재하지 않는 경우 상위 실행 컨텍스트에서 이를 찾고, 모든 상위 실행 컨텍스트에도 해당 이름이 존재하지 않는 경우 오류가 발생한다.</p><figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c">#!/bin/bash</span>
  
<span class="nv">x</span><span class="o">=</span><span class="s2">"variable in global"</span>

<span class="k">function </span>inner<span class="o">()</span> <span class="o">{</span>
  <span class="nb">echo</span> <span class="nv">$x</span>
<span class="o">}</span>

<span class="k">function </span>outer<span class="o">()</span> <span class="o">{</span>
  <span class="nv">x</span><span class="o">=</span><span class="s2">"variable in outer"</span>
  inner
<span class="o">}</span>

inner
outer</code></pre></figure><p>위의 Bash 코드를 실행하면 아래와 같은 결과가 출력된다.</p><figure class="highlight"><pre><code class="language-bash" data-lang="bash">variable <span class="k">in </span>global
variable <span class="k">in </span>outer</code></pre></figure><p>Bash는 Dynamic scope를 사용하는 언어이기 때문에 <code class="language-plaintext highlighter-rouge">inner</code>가 <code class="language-plaintext highlighter-rouge">x</code>라는 변수를 찾을 때는 <code class="language-plaintext highlighter-rouge">inner</code>가 실행될 당시의 Call stack을 추적해야 한다.</p><p>우선 첫번째 <code class="language-plaintext highlighter-rouge">inner</code> 함수가 호출되었을 때, <code class="language-plaintext highlighter-rouge">inner</code> 안에는 <code class="language-plaintext highlighter-rouge">x</code>가 없기 때문에 자신의 상위 실행 컨텍스트에서 선언된 <code class="language-plaintext highlighter-rouge">x</code>를 찾게 된다. 첫번째 <code class="language-plaintext highlighter-rouge">inner</code>의 상위 컨텍스트는 전역 Context이기 때문에 “variable in global” 가 출력된다.</p><p>두번째 <code class="language-plaintext highlighter-rouge">inner</code> 함수 호출은 <code class="language-plaintext highlighter-rouge">outer</code> 내에서 수행되기 때문에 <code class="language-plaintext highlighter-rouge">inner</code>의 상위 컨텍스트는 <code class="language-plaintext highlighter-rouge">outer</code>가 된다. <code class="language-plaintext highlighter-rouge">outer</code> 내에는 “variable in outer” 값을 가진 <code class="language-plaintext highlighter-rouge">x</code>가 존재하기 때문에 “variable in outer” 가 출력된다.</p><p>Dynamic scope를 사용하는 언어는 실제 프로그램이 수행되기 전까지는 함수나 변수에 대한 Binding이 불가능하기 때문에 Late Binding이라고 불린다.</p><h2 id="free-variable-vs-bound-variable">Free variable vs Bound variable</h2><p>자유 변수(Free variable)는 표현식 내에 해당 변수의 선언이 포함되어 있지 않으며, 다른 영역의 값으로 치환 가능한 변수를 의미한다. 이와 반대로, 종속 변수(Bound variable)은 표현식 내에 해당 변수의 선언이 포함되어 있는 변수를 의미한다.</p><figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">const</span> <span class="nx">f</span> <span class="o">=</span> <span class="p">(</span><span class="nx">bound</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">free</span> <span class="o">*</span> <span class="nx">bound</span>
<span class="kd">var</span> <span class="nx">free</span> <span class="o">=</span> <span class="mi">10</span>

<span class="nx">f</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span></code></pre></figure><p>위 코드의 함수 표현식(<code class="language-plaintext highlighter-rouge">(bound) =&gt; free * bound</code>)은 두가지 변수(<code class="language-plaintext highlighter-rouge">free</code>와 <code class="language-plaintext highlighter-rouge">bound</code>)를 가지고 있다. 여기서 <code class="language-plaintext highlighter-rouge">bound</code>는 표현식의 인자에 선언된 값이다. 때문에 <code class="language-plaintext highlighter-rouge">bound</code>는 종속 변수이다. 그러나 <code class="language-plaintext highlighter-rouge">free</code>의 선언은 표현식 외부에 존재하기 때문에 이는 자유 변수이다.</p><p>쉽게 생각하면 종속 변수는 지역 변수, 자유 변수는 그 이외의 변수라고 생각하면 쉽다.</p><h1 id="closure">Closure</h1><figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">createLambdaFunc</span><span class="p">()</span> <span class="p">{</span>
	<span class="kd">let</span> <span class="nx">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">return</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  	<span class="nx">counter</span><span class="o">++</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">counter</span><span class="p">;</span>
  <span class="p">};</span>
<span class="p">}</span>
<span class="kd">const</span> <span class="nx">func</span> <span class="o">=</span> <span class="nx">createLambdaFunc</span><span class="p">();</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">func</span><span class="p">());</span>

<span class="c1">//1이 출력된다.</span></code></pre></figure><p>위의 <code class="language-plaintext highlighter-rouge">createLambdaFunc</code> 가 반환하는 람다 표현식은 Closure가 없이는 실행될 수 없다.</p><p><code class="language-plaintext highlighter-rouge">createLambdaFunc</code>가 반환하는 람다 표현식에서는 자유변수 <code class="language-plaintext highlighter-rouge">counter</code>를 사용하고 있고, 이 <code class="language-plaintext highlighter-rouge">counter</code>는 Lexical Scope 규칙에 따라 <code class="language-plaintext highlighter-rouge">createLambdaFunc</code>에 위치한 <code class="language-plaintext highlighter-rouge">counter</code> 주소를 참조하게 된다. 그러나 <code class="language-plaintext highlighter-rouge">counter</code>는 <code class="language-plaintext highlighter-rouge">createLambdaFunc</code>가 종료됨에 따라 Stack Frame에서 사라지게 되고, 람다 표현식이 실행되는 순간의 <code class="language-plaintext highlighter-rouge">counter</code>는 비정상적인 메모리 주소를 참조하게 된다.</p><p>이러한 문제를 해결하기 위해 Closure라는 기술이 도입되었다. Closure는 자유 변수들을 람다 표현식에 바인딩하는 기술이다. Closure를 사용하면 위의 구문은 아래와 같이 수행된다.</p><ol><li><code class="language-plaintext highlighter-rouge">createLambdaFunc</code>가 반환하는 람다 표현식(<code class="language-plaintext highlighter-rouge">() =&gt; { counter++; return counter; }</code>)은 반환될 때 <strong>자신이 가진 자유 변수 <code class="language-plaintext highlighter-rouge">counter</code>에 대한 참조를 포함하여 반환</strong>된다.<li><code class="language-plaintext highlighter-rouge">func()</code> 가 수행될 때 람다 표현식의 <code class="language-plaintext highlighter-rouge">counter</code>는 <code class="language-plaintext highlighter-rouge">createLambdaFunc</code> 반환 시 포함하였던 <code class="language-plaintext highlighter-rouge">counter</code>를 사용하여 수행된다.</ol><h2 id="분산-처리-프레임워크에서의-closure">분산 처리 프레임워크에서의 Closure</h2><p>Spark이나 Flink와 같은 분산 처리 프레임워크에서도 람다 표현식을 통한 데이터 변환을 지원한다. 분산 처리 프레임워크는 이러한 람다 표현식을 Serialize해서 각 노드들에 배포한 뒤, 각 노드들은 전달받은 람다 표현식을 Deserialize한 뒤 실행한다.</p><p>만일 람다 표현식 내에 자유 변수가 포함되어 있다면 어떻게 될까? 이런 자유 변수 또한 각 노드들로 배포해야 하기 때문에 분산 처리 프레임워크에서는 ClosureCleaner(이름은 다를 수 있다)라는 모듈을 통해 자유 변수를 추적하여 Serialize 한 뒤 배포를 진행한다.</p><p>때문에 람다 표현식 내에 Serializable하지 않은 자유 변수가 포함되어 있는 경우에는 <code class="language-plaintext highlighter-rouge">java.io.NotSerializableException</code>(spark)와 같은 오류가 발생하는 것이다.</p><p>Spark이나 Flink의 각 함수들에서는 아래와 같이 매개변수로 전달받은 람다 표현식에 대해 Closure Cleaning 작업을 수행하게 된다.</p><p><strong>Spark의 RDD</strong></p><figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">def</span> <span class="nf">map</span><span class="o">[</span><span class="kt">U:</span> <span class="kt">ClassTag</span><span class="o">](</span><span class="n">f</span><span class="k">:</span> <span class="kt">T</span> <span class="o">=&gt;</span> <span class="n">U</span><span class="o">)</span><span class="k">:</span> <span class="kt">RDD</span><span class="o">[</span><span class="kt">U</span><span class="o">]</span> <span class="k">=</span> <span class="n">withScope</span> <span class="o">{</span>
  <span class="k">val</span> <span class="nv">cleanF</span> <span class="k">=</span> <span class="nv">sc</span><span class="o">.</span><span class="py">clean</span><span class="o">(</span><span class="n">f</span><span class="o">)</span>
  <span class="k">new</span> <span class="nc">MapPartitionsRDD</span><span class="o">[</span><span class="kt">U</span>, <span class="kt">T</span><span class="o">](</span><span class="k">this</span><span class="o">,</span> <span class="o">(</span><span class="k">_</span><span class="o">,</span> <span class="k">_</span><span class="o">,</span> <span class="n">iter</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nv">iter</span><span class="o">.</span><span class="py">map</span><span class="o">(</span><span class="n">cleanF</span><span class="o">))</span>
<span class="o">}</span>

<span class="k">def</span> <span class="nf">flatMap</span><span class="o">[</span><span class="kt">U:</span> <span class="kt">ClassTag</span><span class="o">](</span><span class="n">f</span><span class="k">:</span> <span class="kt">T</span> <span class="o">=&gt;</span> <span class="nc">TraversableOnce</span><span class="o">[</span><span class="kt">U</span><span class="o">])</span><span class="k">:</span> <span class="kt">RDD</span><span class="o">[</span><span class="kt">U</span><span class="o">]</span> <span class="k">=</span> <span class="n">withScope</span> <span class="o">{</span>
  <span class="k">val</span> <span class="nv">cleanF</span> <span class="k">=</span> <span class="nv">sc</span><span class="o">.</span><span class="py">clean</span><span class="o">(</span><span class="n">f</span><span class="o">)</span>
  <span class="k">new</span> <span class="nc">MapPartitionsRDD</span><span class="o">[</span><span class="kt">U</span>, <span class="kt">T</span><span class="o">](</span><span class="k">this</span><span class="o">,</span> <span class="o">(</span><span class="k">_</span><span class="o">,</span> <span class="k">_</span><span class="o">,</span> <span class="n">iter</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nv">iter</span><span class="o">.</span><span class="py">flatMap</span><span class="o">(</span><span class="n">cleanF</span><span class="o">))</span>
<span class="o">}</span></code></pre></figure><p><strong>Flink의 Dataset</strong></p><figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">def</span> <span class="nf">map</span><span class="o">[</span><span class="kt">R:</span> <span class="kt">TypeInformation:</span> <span class="kt">ClassTag</span><span class="o">](</span><span class="n">fun</span><span class="k">:</span> <span class="kt">T</span> <span class="o">=&gt;</span> <span class="n">R</span><span class="o">)</span><span class="k">:</span> <span class="kt">DataSet</span><span class="o">[</span><span class="kt">R</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
  <span class="nf">if</span> <span class="o">(</span><span class="n">fun</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nc">NullPointerException</span><span class="o">(</span><span class="s">"Map function must not be null."</span><span class="o">)</span>
  <span class="o">}</span>
  <span class="k">val</span> <span class="nv">mapper</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">MapFunction</span><span class="o">[</span><span class="kt">T</span>, <span class="kt">R</span><span class="o">]</span> <span class="o">{</span>
    <span class="k">val</span> <span class="nv">cleanFun</span> <span class="k">=</span> <span class="nf">clean</span><span class="o">(</span><span class="n">fun</span><span class="o">)</span>
    <span class="k">def</span> <span class="nf">map</span><span class="o">(</span><span class="n">in</span><span class="k">:</span> <span class="kt">T</span><span class="o">)</span><span class="k">:</span> <span class="kt">R</span> <span class="o">=</span> <span class="nf">cleanFun</span><span class="o">(</span><span class="n">in</span><span class="o">)</span>
  <span class="o">}</span>
  <span class="nf">wrap</span><span class="o">(</span><span class="k">new</span> <span class="nc">MapOperator</span><span class="o">[</span><span class="kt">T</span>, <span class="kt">R</span><span class="o">](</span><span class="n">javaSet</span><span class="o">,</span>
    <span class="n">implicitly</span><span class="o">[</span><span class="kt">TypeInformation</span><span class="o">[</span><span class="kt">R</span><span class="o">]],</span>
    <span class="n">mapper</span><span class="o">,</span>
    <span class="nf">getCallLocationName</span><span class="o">())</span>
  <span class="o">)</span>
<span class="o">}</span></code></pre></figure><p>이러한 Cleaner들은 사용하지 않는 자유변수 혹은 자유변수 내부의 Reference를 지우는 작업도 추가적으로 수행하게 된다.</p><h1 id="참고-자료">참고 자료</h1><ul><li><a href="https://en.wikipedia.org/wiki/Closure_(computer_programming)">Wikipedia - Closure(computer programming)</a><li><a href="https://en.wikipedia.org/wiki/Scope_(computer_science)">Wikipedia - Scope(computer programming)</a><li><a href="https://github.com/apache/spark/blob/master/core/src/main/scala/org/apache/spark/rdd/RDD.scala">Github - Spark(RDD)</a><li><a href="https://github.com/apache/flink/blob/master/flink-scala/src/main/scala/org/apache/flink/api/scala/DataSet.scala">Github - Flink(Dataset)</a><li><a href="https://ci.apache.org/projects/flink/flink-docs-stable/dev/execution_configuration.html">Flink Documentation - Execution config</a><li><a href="https://stackoverflow.com/questions/25007848/the-purpose-of-closurecleaner-clean">Stackoverflow - The purpose of ClosureCleaner.clean</a></ul></div><div class="post-tail-wrapper text-muted"><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/fp/" class="post-tag no-text-decoration" >fp</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Closure란? - leeyh0216's devlog&url=https://leeyh0216.github.io/posts/closure/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Closure란? - leeyh0216's devlog&u=https://leeyh0216.github.io/posts/closure/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Closure란? - leeyh0216's devlog&url=https://leeyh0216.github.io/posts/closure/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ps/">ps</a> <a class="post-tag" href="/tags/spring/">spring</a> <a class="post-tag" href="/tags/leetcode/">leetcode</a> <a class="post-tag" href="/tags/apache-spark/">apache-spark</a> <a class="post-tag" href="/tags/java/">java</a> <a class="post-tag" href="/tags/kafka/">kafka</a> <a class="post-tag" href="/tags/apache-druid/">apache-druid</a> <a class="post-tag" href="/tags/string/">string</a> <a class="post-tag" href="/tags/study/">study</a> <a class="post-tag" href="/tags/docker/">docker</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/fold_left_right/"><div class="card-body"> <span class="timeago small" > Jan 7, 2021 <i class="unloaded">2021-01-07T00:40:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>FoldLeft와 FoldRight 제대로 알고 사용하기</h3><div class="text-muted small"><p> Fold Fold는 주어진 결합 함수(Combining Operation)를 데이터 구조에 대해 재귀적으로 호출하여 결과 값을 만들어내는 고계 함수(Higher-Order Function)이다. 잠시 List에 대해서 생각해보자. List는 아래와 같이 두 개로 분류할 수 있다. 빈 List(보통 Nil이라고 부르며, []로 표현한다. In...</p></div></div></a></div><div class="card"> <a href="/posts/heap-and-gc/"><div class="card-body"> <span class="timeago small" > Jul 14 <i class="unloaded">2024-07-14T17:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>JVM Heap과 GC를 다른 관점에서 바라보기</h3><div class="text-muted small"><p> 개요 Garbage Collection을 검색해보면 대부분의 글이 특정 GC(CMS, G1, Z 등)의 배경이 되는 이론(ex. Generational Collection Theory)이나, 알고리즘(ex. Mark-Sweep), 튜닝 등에 대한 내용을 다루고 있다. 그리고 해당 이론에 근거하여 Heap 메모리의 구조를 설명하다보니, Heap 영역을...</p></div></div></a></div><div class="card"> <a href="/posts/protobuf_2_5_build/"><div class="card-body"> <span class="timeago small" > Mar 10 <i class="unloaded">2024-03-10T12:10:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>protobuf 2.5 빌드하기(Apple Silicon)</h3><div class="text-muted small"><p> 이 문제는 Apple Silicon(M1, M2, M3 등)에서만 발생합니다. Ubuntu나 Intel Mac에서는 발생하지 않을 수 있음을 유의하시기 바랍니다. Hadoop 3.2.2 버전을 빌드하려다보니, 아래와 같은 메시지가 발생하며 빌드에 실패하였다. 1 [ERROR] Failed to execute goal org.apache.ha...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/fold_left_right/" class="btn btn-outline-primary" prompt="Older"><p>FoldLeft와 FoldRight 제대로 알고 사용하기</p></a> <a href="/posts/flink_checkpoint_1/" class="btn btn-outline-primary" prompt="Newer"><p>Flink Concept - Checkpointing(1)</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://twitter.com/username">leeyh0216</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/ps/">ps</a> <a class="post-tag" href="/tags/spring/">spring</a> <a class="post-tag" href="/tags/leetcode/">leetcode</a> <a class="post-tag" href="/tags/apache-spark/">apache spark</a> <a class="post-tag" href="/tags/java/">java</a> <a class="post-tag" href="/tags/kafka/">kafka</a> <a class="post-tag" href="/tags/apache-druid/">apache druid</a> <a class="post-tag" href="/tags/string/">string</a> <a class="post-tag" href="/tags/study/">study</a> <a class="post-tag" href="/tags/docker/">docker</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://leeyh0216.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
